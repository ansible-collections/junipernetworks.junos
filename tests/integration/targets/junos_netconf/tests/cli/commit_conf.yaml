---
- ansible.builtin.debug:
    msg: START ios_cliconf integration tests on connection={{ ansible_connection }}

- name: Reset
  vars:
    ansible_connection: 'ansible.netcommon.netconf'
  junipernetworks.junos.junos_hostname:
    state: deleted

- name: Verify hostname changed immediately
  vars:
    ansible_connection: 'ansible.netcommon.netconf'
  register: get_hostname
  junipernetworks.junos.junos_hostname:
    state: gathered

- name: Change hostname with commit_confirm_immediate true and timer 2 minutes
  vars:
    ansible_junos_commit_confirmed: true
    ansible_junos_commit_confirmed_timeout: 2
    ansible_connection: 'ansible.netcommon.netconf'
  junipernetworks.junos.junos_hostname:
    state: merged
    config:
      hostname: testConfirmCommitAppliance

- name: Gather hostname
  vars:
    ansible_connection: 'ansible.netcommon.netconf'
  register: get_hostname
  junipernetworks.junos.junos_hostname:
    state: gathered

- name: Assert that the hostname is correctly set
  ansible.builtin.assert:
    that:
      - "'testConfirmCommitAppliance'  == in get_hostname.gathered.hostname"

- name: Sleep for 300 seconds and continue with play
  ansible.builtin.wait_for:
    timeout: 150
  delegate_to: localhost

- name: Verify hostname change is persistent even after timeout
  vars:
    ansible_connection: 'ansible.netcommon.netconf'
  register: get_hostname
  junipernetworks.junos.junos_hostname:
    state: gathered

- name: Assert that the hostname is correctly set
  ansible.builtin.assert:
    that:
      - "{} == get_hostname.gathered"

- name: Clenup
  vars:
    ansible_connection: 'ansible.netcommon.netconf'
  junipernetworks.junos.junos_hostname:
    state: deleted
